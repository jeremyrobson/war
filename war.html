<!doctype html>
<html>
<head>
<script>
var canvas, context, interval;
var width=64, height=48;
var tile;
var funds = 0;
var unit, proj, disp;
var mx=0, my=0;

var colors = {
    "grass": "rgb(100,155,100)"
};

function loop() {
    unit.filter(function(u) {
        return u.hp > 0;
    }).forEach(function(u) {
        u.update();
    });
    
    proj = proj.filter(function(p) {
        return p.life > 0;
    });
    
    proj.forEach(function(p) {
        p.update();
    });
    
    disp = disp.filter(function(d) {
        return d.life > 0;
    });
    
    disp.forEach(function(d) {
        d.update();
    });
    
    draw();
}

function draw() {
    for (var x=0;x<width;x++) {
        for (var y=0;y<height;y++) {
            context.fillStyle = colors[tile[x][y]];
            context.fillRect(x*10,y*10,10,10);
        }
    }
    
    unit.forEach(function(u) {
        context.fillStyle = u.color;
        context.fillRect(u.x*10,u.y*10,10,10);
    });
    
    proj.forEach(function(p) {
        context.fillStyle = p.color;
        context.fillRect(p.x*10,p.y*10,5,5);
    });
    
    disp.forEach(function(d) {
        context.font = d.font;
        context.fillStyle = d.color;
        context.fillText(d.text, d.x, d.y);
    });
    
    context.font = "32px Arial";
    context.fillStyle = "rgb(255,255,255)";
    context.fillText("Funds: $" + funds, 32, 32);
}

function dist(a, b) {
    var distance = 0;
    var dx = a.x - b.x;
    var dy = a.y - b.y;
    distance = Math.sqrt(dx*dx + dy*dy);
    return distance;
}

function create_disp(text, x, y, font, color) {
    var newdisp = {};
    newdisp.text = text;
    newdisp.x = x;
    newdisp.y = y;
    newdisp.font = font;
    newdisp.color = color;
    newdisp.life = 100;
    
    newdisp.update = function() {
        newdisp.y -= 1;
        newdisp.life -= 1;
    };
    
    return newdisp;
};

function create_proj(a, b, pwr, ai) {
    var newproj = {};
    newproj.x = a.x;
    newproj.y = a.y;
    newproj.pwr = pwr;
    newproj.target = b;
    newproj.life = 100;
    
    if (ai == "heal") {
        newproj.color = "rgb(0,255,255)";
        newproj.pwr = -newproj.pwr;
    }
    else {
        if (a.side == "user")
            newproj.color = "rgb(255,255,0)";
        else
            newproj.color = "rgb(255,0,255)";
    }
    
    var angle = Math.atan2(b.x-a.x,b.y-a.y);
    newproj.vx = Math.sin(angle);
    newproj.vy = Math.cos(angle);
    newproj.distance = 0;
    
    newproj.update = function() {
        newproj.x += newproj.vx;
        newproj.y += newproj.vy;
        newproj.distance = dist(newproj, newproj.target);
        newproj.life -= 1;
        if (newproj.distance < 1 && newproj.target.hp > 0) {
            newproj.life = 0;
            newproj.target.hp -= newproj.pwr;
            if (newproj.target.hp <= 0)
                newproj.target.die();
        }
    };
    
    return newproj;
}

function create_unit(side) {
    var newunit = {};
    newunit.id = Math.floor(Math.random() * 100000);
    newunit.ai = "attack";
    newunit.side = side;
    newunit.range = Math.floor(Math.random() * 50) + 5;
    newunit.charge = Math.floor(Math.random() * 100);
    newunit.maxhp = 100;
    newunit.hp = newunit.maxhp;
    newunit.pwr = Math.floor(Math.random()*5) + 1;
    newunit.agl = Math.floor(Math.random()*10) + 1;
    
    if (side == "user") {
        newunit.colors = ["rgb(0,0,0)", "rgb(0,155,0)", "rgb(0,200,0)", "rgb(0,225,0)", "rgb(0,255,0)"];
        newunit.x = 0 + Math.floor(Math.random()*10);
        newunit.vx = 1;
        newunit.vy = 0;
    }
    else {
        newunit.colors = ["rgb(0,0,0)", "rgb(155,0,0)", "rgb(200,0,0)", "rgb(225,0,0)", "rgb(255,0,0)"];
        newunit.x = width - 1 - Math.floor(Math.random()*10);
        newunit.vx = -1;
        newunit.vy = 0;
    }
    
    newunit.color = newunit.colors[Math.floor((newunit.colors.length-1) * newunit.hp/newunit.maxhp)];
    newunit.y = Math.floor(Math.random() * height);
    newunit.target = null;
    
    newunit.update = function() {
        newunit.color = newunit.colors[Math.floor((newunit.colors.length-1) * newunit.hp/newunit.maxhp)];
        
        if (newunit.hp < newunit.maxhp*2/3) {
            newunit.ai = "run";
        }
        
        if (!newunit.target) {
            newunit.target = newunit.get_target(newunit.ai);
        }
        else {
            newunit.act();
        }
    
        newunit.move();
        
        newunit.charge += newunit.agl;
    };
    
    newunit.act = function() {
        var distance = dist(newunit, newunit.target);
        var angle = Math.atan2(newunit.target.x-newunit.x,newunit.target.y-newunit.y);
        
        if (newunit.ai == "run") {
            newunit.vx = -Math.sin(angle)/2;
            newunit.vy = -Math.cos(angle)/2;
        }
        else {
            if (distance <= newunit.range) { //stop
                newunit.vx = 0;
                newunit.vy = 0;
            }
            else { //move closer to target
                newunit.vx = Math.sin(angle)/2;
                newunit.vy = Math.cos(angle)/2;
            }
        }
        
        if (newunit.charge >= 100 && distance <= newunit.range)
            newunit.attack();
        
        if (newunit.target.hp <= 0)
            newunit.target = null;
    };
    
    newunit.attack = function() {
        proj.push(create_proj(newunit, newunit.target, newunit.pwr, newunit.ai));
        newunit.charge = 0;
    };
    
    newunit.move = function() {
        var x = newunit.x + newunit.vx;
        var y = newunit.y + newunit.vy;
        if (x >= 0 && x < width-1)
            newunit.x = x;
        if (y >=0 && y < height-1)
            newunit.y = y;
    }
    
    newunit.get_target = function(ai) {
        var target = null;
        var best = [];
        if (ai == "heal") {
            best = unit.filter(function(u) { //create list of ally targets
                return u.id != newunit.id && u.hp > 0 && u.side == newunit.side;
            });
            console.log(best);
            if (best.length > 0) { //get most damaged target
                best.sort(function(a,b) {
                    return a.hp - b.hp;
                });
                target = best[0];
            }
        }
        
        if (target == null) {
            unit.forEach(function(u) { //create list of enemy targets
                if (newunit.side != u.side && u.hp > 0) {
                    var distance = dist(newunit, u);
                    best.push({"unit":u, "distance":distance});
                }
            });
            if (best.length > 0) { //get closest target
                best.sort(function(a,b) {
                    return a.distance - b.distance;
                });
                target = best[0].unit;
            }
        }
        
        return target;
    };
    
    newunit.die = function() {
        newunit.hp = 0;
        if (newunit.side != "user") {
            funds += 10;
            disp.push(create_disp("$10", newunit.x*10, newunit.y*10, "24px Arial", "rgb(255,255,255)"));
        }
    };
    
    return newunit;
}

function create_party(side) {
    var newparty = {};
    newparty.side = side;
    newparty.unit = [];
    for (var i=0;i<10;i++) {
        newparty.unit[i] = create_unit(side);
    }
    return newparty.unit;
}

window.onload = function() {
    canvas = document.getElementById("canvas");
    context = canvas.getContext("2d");
    context.textBaseline = "top";
    
    canvas.onmousemove = function(e) {
        mx = Math.floor(e.offsetX/10);
        my = Math.floor(e.offsetY/10);
    };
    
    tile = [];
    for (var x=0;x<width;x++) {
        tile[x] = [];
        for (var y=0;y<height;y++) {
            tile[x][y] = "grass";
        }
    }
    
    unit = create_party("user");
    unit = unit.concat(create_party("cpu"));
    proj = [];
    disp = [];
    
    interval = window.setInterval(loop, 1000/60);
};
</script>
<body>
<canvas width="640" height="480" id="canvas"></canvas>
</body>
</html>
